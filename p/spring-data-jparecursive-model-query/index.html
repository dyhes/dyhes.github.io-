<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='// simplified @Data @Entity @Table(name = "comments") @EntityListeners(AuditingEntityListener.class) public class Comment { @Id @GeneratedValue(strategy=GenerationType.IDENTITY) private Long id; @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = "parent_id") private Comment parent; @OneToMany(mappedBy = "parent", orphanRemoval = true) private List<Comment> children = new ArrayList<>(); } FetchType.EAGER public Comment getCommentWithChildren(Long commentId) { return commentRepository.findById(commentId).orElse(null); } Derived Method public List<Comment> findSubcomments(Long commentId) { Comment rootComment = commentRepository.findById(commentId).orElse(null); if (rootComment == null) { return null; // or throw an exception if preferred } fetchChildren(rootComment); return List.of(rootComment); } private void fetchChildren(Comment parent) { List<Comment> children = commentRepository.findByParentId(parent.getId()); parent.setChildren(children); for (Comment child : children) { fetchChildren(child); } } Common Table Expressions (CTEs) Spring Data JPA does not support recursive queries out-of-the-box, but you can use native queries to achieve this. Below is an example of how you can perform a recursive query using a native query in Spring Data JPA.\n'><title>【Spring Data JPA】Recursive Model Query</title>
<link rel=canonical href=https://dyhes.github.io/p/spring-data-jparecursive-model-query/><link rel=stylesheet href=/scss/style.min.6aa4d43a5cae1c51ef34b3f851ae7421f4b2f2d13827e2d975acbeb4f13c8710.css><meta property='og:title' content="【Spring Data JPA】Recursive Model Query"><meta property='og:description' content='// simplified @Data @Entity @Table(name = "comments") @EntityListeners(AuditingEntityListener.class) public class Comment { @Id @GeneratedValue(strategy=GenerationType.IDENTITY) private Long id; @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = "parent_id") private Comment parent; @OneToMany(mappedBy = "parent", orphanRemoval = true) private List<Comment> children = new ArrayList<>(); } FetchType.EAGER public Comment getCommentWithChildren(Long commentId) { return commentRepository.findById(commentId).orElse(null); } Derived Method public List<Comment> findSubcomments(Long commentId) { Comment rootComment = commentRepository.findById(commentId).orElse(null); if (rootComment == null) { return null; // or throw an exception if preferred } fetchChildren(rootComment); return List.of(rootComment); } private void fetchChildren(Comment parent) { List<Comment> children = commentRepository.findByParentId(parent.getId()); parent.setChildren(children); for (Comment child : children) { fetchChildren(child); } } Common Table Expressions (CTEs) Spring Data JPA does not support recursive queries out-of-the-box, but you can use native queries to achieve this. Below is an example of how you can perform a recursive query using a native query in Spring Data JPA.\n'><meta property='og:url' content='https://dyhes.github.io/p/spring-data-jparecursive-model-query/'><meta property='og:site_name' content='飞鸿踏雪泥'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Spring Data JPA'><meta property='article:published_time' content='2024-08-15T00:00:00+00:00'><meta property='article:modified_time' content='2024-08-15T00:00:00+00:00'><meta name=twitter:title content="【Spring Data JPA】Recursive Model Query"><meta name=twitter:description content='// simplified @Data @Entity @Table(name = "comments") @EntityListeners(AuditingEntityListener.class) public class Comment { @Id @GeneratedValue(strategy=GenerationType.IDENTITY) private Long id; @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = "parent_id") private Comment parent; @OneToMany(mappedBy = "parent", orphanRemoval = true) private List<Comment> children = new ArrayList<>(); } FetchType.EAGER public Comment getCommentWithChildren(Long commentId) { return commentRepository.findById(commentId).orElse(null); } Derived Method public List<Comment> findSubcomments(Long commentId) { Comment rootComment = commentRepository.findById(commentId).orElse(null); if (rootComment == null) { return null; // or throw an exception if preferred } fetchChildren(rootComment); return List.of(rootComment); } private void fetchChildren(Comment parent) { List<Comment> children = commentRepository.findByParentId(parent.getId()); parent.setChildren(children); for (Comment child : children) { fetchChildren(child); } } Common Table Expressions (CTEs) Spring Data JPA does not support recursive queries out-of-the-box, but you can use native queries to achieve this. Below is an example of how you can perform a recursive query using a native query in Spring Data JPA.\n'><link rel="shortcut icon" href=/github.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu17834253352308399148.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>飞鸿踏雪泥</a></h1><h2 class=site-description>没有记录，就没有发生</h2></div></header><ol class=menu-social><li><a href=https://github.com/dyhes target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:dyheslin@gmail.com target=_blank title=Gmail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-gmail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 20h3a1 1 0 001-1V5a1 1 0 00-1-1h-3v16z"/><path d="M5 20h3V4H5A1 1 0 004 5v14a1 1 0 001 1z"/><path d="M16 4l-4 4-4-4"/><path d="M4 6.5l8 7.5 8-7.5"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/categories/><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>Categories</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#fetchtypeeager>FetchType.EAGER</a></li><li><a href=#derived-method>Derived Method</a></li><li><a href=#common-table-expressions-ctes>Common Table Expressions (CTEs)</a></li><li><a href=#performance-considerations>Performance Considerations</a><ol><li><a href=#ctes>CTEs</a><ol><li><a href=#pros>Pros:</a></li><li><a href=#cons>Cons:</a></li></ol></li><li><a href=#performance-comparison>Performance Comparison</a></li><li><a href=#recommendations>Recommendations</a></li><li><a href=#conclusion>Conclusion</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/nutrition/ style=background-color:#93b5cf;color:>积雪粮
</a><a href=/categories/willow/ style=background-color:#dc9123;color:>满城风絮</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/spring-data-jparecursive-model-query/>【Spring Data JPA】Recursive Model Query</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Aug 15, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>3 minute read</time></div></footer></div></header><section class=article-content><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// simplified</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Entity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Table</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;comments&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EntityListeners</span><span class=p>(</span><span class=n>AuditingEntityListener</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Comment</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GeneratedValue</span><span class=p>(</span><span class=n>strategy</span><span class=o>=</span><span class=n>GenerationType</span><span class=p>.</span><span class=na>IDENTITY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ManyToOne</span><span class=p>(</span><span class=n>fetch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>FetchType</span><span class=p>.</span><span class=na>LAZY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@JoinColumn</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;parent_id&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Comment</span><span class=w> </span><span class=n>parent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@OneToMany</span><span class=p>(</span><span class=n>mappedBy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;parent&#34;</span><span class=p>,</span><span class=w> </span><span class=n>orphanRemoval</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Comment</span><span class=o>&gt;</span><span class=w> </span><span class=n>children</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=fetchtypeeager>FetchType.EAGER</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Comment</span><span class=w> </span><span class=nf>getCommentWithChildren</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>commentId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>commentRepository</span><span class=p>.</span><span class=na>findById</span><span class=p>(</span><span class=n>commentId</span><span class=p>).</span><span class=na>orElse</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=derived-method>Derived Method</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Comment</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findSubcomments</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>commentId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Comment</span><span class=w> </span><span class=n>rootComment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>commentRepository</span><span class=p>.</span><span class=na>findById</span><span class=p>(</span><span class=n>commentId</span><span class=p>).</span><span class=na>orElse</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootComment</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// or throw an exception if preferred</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fetchChildren</span><span class=p>(</span><span class=n>rootComment</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>List</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>rootComment</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>fetchChildren</span><span class=p>(</span><span class=n>Comment</span><span class=w> </span><span class=n>parent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Comment</span><span class=o>&gt;</span><span class=w> </span><span class=n>children</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>commentRepository</span><span class=p>.</span><span class=na>findByParentId</span><span class=p>(</span><span class=n>parent</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>parent</span><span class=p>.</span><span class=na>setChildren</span><span class=p>(</span><span class=n>children</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Comment</span><span class=w> </span><span class=n>child</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>children</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fetchChildren</span><span class=p>(</span><span class=n>child</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=common-table-expressions-ctes>Common Table Expressions (CTEs)</h2><p>Spring Data JPA does not support recursive queries out-of-the-box, but you can use native queries to achieve this. Below is an example of how you can perform a recursive query using a native query in Spring Data JPA.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Query</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;WITH RECURSIVE Subcomments AS (&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=s>&#34;    SELECT c.id, c.content, c.parent_id &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=s>&#34;    FROM Comment c &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=s>&#34;    WHERE c.id = :commentId &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=s>&#34;    UNION ALL &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=s>&#34;    SELECT c.id, c.content, c.parent_id &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=s>&#34;    FROM Comment c &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=s>&#34;    INNER JOIN Subcomments s ON c.parent_id = s.id&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=s>&#34;) &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=s>&#34;SELECT * FROM Subcomments&#34;</span><span class=p>,</span><span class=w> </span><span class=n>nativeQuery</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>Comment</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findSubcomments</span><span class=p>(</span><span class=nd>@Param</span><span class=p>(</span><span class=s>&#34;commentId&#34;</span><span class=p>)</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>commentId</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>The fetched result is a flatten list of Comment.</p><h2 id=performance-considerations>Performance Considerations</h2><h3 id=ctes>CTEs</h3><h4 id=pros>Pros:</h4><ul><li><strong>Efficiency</strong>: Fetching the entire hierarchy in a single query is efficient and reduces the number of database round-trips.</li><li><strong>Control</strong>: You have fine-grained control over how the data is processed and structured in the application layer.</li></ul><h4 id=cons>Cons:</h4><ul><li><strong>Complexity</strong>: The reconstruction of the recursive structure in the application layer can be complex and error-prone.</li><li><strong>Memory Usage</strong>: Depending on the size of the dataset, holding the entire hierarchy in memory for reconstruction can be memory-intensive.</li><li><strong>Performance Overhead</strong>: The reconstruction process itself can introduce performance overhead, especially if the hierarchy is deep or has many nodes.</li></ul><h3 id=performance-comparison>Performance Comparison</h3><ol><li><p><strong>Native Query and CTEs with Reconstruction</strong>:</p><ul><li><strong>Pros</strong>:<ul><li>Efficiently fetches the entire hierarchy in a single query.</li><li>Minimizes the number of database round-trips.</li></ul></li><li><strong>Cons</strong>:<ul><li>Complexity in reconstructing the hierarchy in the application layer.</li><li>Potential memory usage concerns if the dataset is large.</li><li>Additional performance overhead due to the reconstruction process.</li></ul></li></ul></li><li><p><strong>FetchType.EAGER</strong>:</p><ul><li><strong>Pros</strong>:<ul><li>Simplifies data access by automatically fetching children.</li><li>Avoids the need for manual reconstruction.</li></ul></li><li><strong>Cons</strong>:<ul><li>Performance overhead due to eager fetching, especially with large datasets.</li><li>Risk of the N+1 query problem.</li><li>Increased memory usage due to loading entire collections.</li></ul></li></ul></li><li><p><strong>Derived Methods and Manually Assembling</strong>:</p><ul><li><strong>Pros</strong>:<ul><li>Flexibility and simplicity in using JPA abstractions.</li><li>Allows for fine-grained control over data fetching and processing.</li></ul></li><li><strong>Cons</strong>:<ul><li>Potential performance overhead due to multiple queries.</li><li>Complexity in manually assembling the hierarchical structure.</li><li>Risk of performance and consistency issues if not managed carefully.</li></ul></li></ul></li></ol><h3 id=recommendations>Recommendations</h3><ul><li><strong>For Large, Complex Hierarchies</strong>: Use native queries with CTEs for efficient data fetching. Be prepared to handle the complexity of reconstructing the hierarchy in the application layer. This approach provides the best performance but requires careful implementation.</li><li><strong>For Small to Medium Hierarchies</strong>: Use <code>FetchType.EAGER</code> for convenience and simplicity. Monitor performance and memory usage to ensure it remains within acceptable limits.</li><li><strong>For Flexible, Maintainable Code</strong>: Use derived methods and manually assemble the hierarchical structure if the performance impact is manageable. This approach offers a good balance between flexibility and simplicity.</li></ul><h3 id=conclusion>Conclusion</h3><ul><li><strong>Native Query and CTEs with Reconstruction</strong>: Best for performance but requires careful handling of the reconstruction phase.</li><li><strong>FetchType.EAGER</strong>: Convenient but can lead to performance and memory overhead.</li><li><strong>Derived Methods and Manual Assembly</strong>: Flexible and maintainable with acceptable performance for smaller datasets.</li></ul><p>Ultimately, the choice depends on your specific use case, dataset size, and performance requirements. Always profile and benchmark your application to make an informed decision based on actual performance metrics.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/spring-data-jpa/>Spring Data JPA</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Aug 15, 2024 00:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/spring-data-jpadatabase-exception/><div class=article-details><h2 class=article-title>【Spring Data JPA】Database Exception</h2></div></a></article><article><a href=/p/spring-data-jpareference-object/><div class=article-details><h2 class=article-title>【Spring Data JPA】Reference Object</h2></div></a></article><article class=has-image><a href=/p/javaenum/><div class=article-image><img src=/covers/cover19.png loading=lazy data-key data-hash=/covers/cover19.png></div><div class=article-details><h2 class=article-title>【Java】Enum</h2></div></a></article><article class=has-image><a href=/p/spring-data-jpa@query-and-jpql/><div class=article-image><img src=/covers/cover19.png loading=lazy data-key data-hash=/covers/cover19.png></div><div class=article-details><h2 class=article-title>【Spring Data JPA】@Query and JPQL</h2></div></a></article><article><a href=/p/spring-data-jpapageable-and-sort/><div class=article-details><h2 class=article-title>【Spring Data JPA】Pageable and Sort</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 飞鸿踏雪泥</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>